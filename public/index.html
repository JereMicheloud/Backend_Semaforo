<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Semáforos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin-bottom: 5px;
        }

        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .sensor1 { color: #e74c3c; }
        .sensor2 { color: #3498db; }
        .sensor3 { color: #2ecc71; }
        .sensor4 { color: #f39c12; }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .controls button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .controls button:hover {
            transform: translateY(-2px);
        }

        .controls button.active {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .last-update {
            text-align: center;
            color: #666;
            margin-top: 20px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .charts-container,
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sistema de Monitoreo de Semáforos</h1>
        <div class="status">
            <div class="status-dot"></div>
            <span>Conectado en tiempo real</span>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <h3>Período de visualización</h3>
            <button onclick="updateCharts(1)" class="active" id="btn-1h">1 Hora</button>
            <button onclick="updateCharts(6)" id="btn-6h">6 Horas</button>
            <button onclick="updateCharts(24)" id="btn-24h">24 Horas</button>
            <button onclick="updateCharts(168)" id="btn-7d">7 Días</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Sensor 1</h3>
                <div class="stat-value sensor1" id="sensor1-value">--</div>
                <div>cm</div>
            </div>
            <div class="stat-card">
                <h3>Sensor 2</h3>
                <div class="stat-value sensor2" id="sensor2-value">--</div>
                <div>cm</div>
            </div>
            <div class="stat-card">
                <h3>Sensor 3</h3>
                <div class="stat-value sensor3" id="sensor3-value">--</div>
                <div>cm</div>
            </div>
            <div class="stat-card">
                <h3>Sensor 4</h3>
                <div class="stat-value sensor4" id="sensor4-value">--</div>
                <div>cm</div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h3>📈 Lecturas en Tiempo Real</h3>
                <canvas id="realTimeChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>📊 Promedios por Sensor</h3>
                <canvas id="averageChart"></canvas>
            </div>
        </div>

        <div class="analytics-grid">
            <div class="analytics-card">
                <h3>📋 Estadísticas del Período</h3>
                <div id="analytics-content">
                    <p>Total de lecturas: <strong id="total-readings">--</strong></p>
                    <p>Alertas detectadas: <strong id="alerts-count">--</strong></p>
                    <p>Rango de tiempo: <strong id="time-range">--</strong></p>
                </div>
            </div>
            <div class="analytics-card">
                <h3>⚠️ Estado de Sensores</h3>
                <div id="sensor-status">
                    <div id="sensor-alerts"></div>
                </div>
            </div>
        </div>

        <div class="last-update" id="last-update">
            Última actualización: --
        </div>
    </div>

    <script>
        let realTimeChart, averageChart;
        let socket;
        let currentPeriod = 1; // horas

        // Configuración de Chart.js
        Chart.defaults.font.family = "'Segoe UI', sans-serif";
        Chart.defaults.color = '#666';

        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            initializeWebSocket();
            loadInitialData();
            
            // Actualizar datos cada 30 segundos
            setInterval(loadCurrentData, 30000);
        });

        function initializeWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('🔌 Conectado al servidor');
                socket.emit('subscribe-sensors');
            });

            socket.on('sensor-data', function(data) {
                console.log('📊 Nuevos datos recibidos:', data);
                updateRealtimeDisplay(data);
            });

            socket.on('disconnect', function() {
                console.log('🔌 Desconectado del servidor');
            });
        }

        function initializeCharts() {
            // Gráfico en tiempo real
            const ctx1 = document.getElementById('realTimeChart').getContext('2d');
            realTimeChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Sensor 1',
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            data: []
                        },
                        {
                            label: 'Sensor 2',
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            data: []
                        },
                        {
                            label: 'Sensor 3',
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            data: []
                        },
                        {
                            label: 'Sensor 4',
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            data: []
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Distancia (cm)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            // Gráfico de promedios
            const ctx2 = document.getElementById('averageChart').getContext('2d');
            averageChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Sensor 1', 'Sensor 2', 'Sensor 3', 'Sensor 4'],
                    datasets: [{
                        label: 'Promedio (cm)',
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(231, 76, 60, 0.8)',
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(243, 156, 18, 0.8)'
                        ],
                        borderColor: [
                            '#e74c3c',
                            '#3498db',
                            '#2ecc71',
                            '#f39c12'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Distancia (cm)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        async function loadInitialData() {
            await Promise.all([
                loadCurrentData(),
                updateCharts(currentPeriod)
            ]);
        }

        async function loadCurrentData() {
            try {
                const response = await fetch('/api/sensors/latest');
                const data = await response.json();
                
                if (data.success && data.data) {
                    updateCurrentValues(data.data);
                }
            } catch (error) {
                console.error('Error al cargar datos actuales:', error);
            }
        }

        async function updateCharts(hours) {
            currentPeriod = hours;
            
            // Actualizar botones activos
            document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${hours}h`).classList.add('active');
            
            try {
                const [chartResponse, analyticsResponse] = await Promise.all([
                    fetch(`/api/sensors/chart-data?hours=${hours}`),
                    fetch(`/api/sensors/analytics?hours=${hours}`)
                ]);

                const chartData = await chartResponse.json();
                const analyticsData = await analyticsResponse.json();

                if (chartData.success) {
                    updateRealtimeChart(chartData.data);
                }

                if (analyticsData.success) {
                    updateAnalytics(analyticsData.data);
                }
            } catch (error) {
                console.error('Error al actualizar gráficos:', error);
            }
        }

        function updateCurrentValues(data) {
            document.getElementById('sensor1-value').textContent = data.sensor1.toFixed(1);
            document.getElementById('sensor2-value').textContent = data.sensor2.toFixed(1);
            document.getElementById('sensor3-value').textContent = data.sensor3.toFixed(1);
            document.getElementById('sensor4-value').textContent = data.sensor4.toFixed(1);
            
            document.getElementById('last-update').textContent = 
                `Última actualización: ${new Date(data.createdAt).toLocaleString()}`;
        }

        function updateRealtimeChart(data) {
            const chartData = data.map(point => ({
                x: new Date(point.timestamp * 1000),
                y1: point.sensor1,
                y2: point.sensor2,
                y3: point.sensor3,
                y4: point.sensor4
            }));

            realTimeChart.data.datasets[0].data = chartData.map(p => ({x: p.x, y: p.y1}));
            realTimeChart.data.datasets[1].data = chartData.map(p => ({x: p.x, y: p.y2}));
            realTimeChart.data.datasets[2].data = chartData.map(p => ({x: p.x, y: p.y3}));
            realTimeChart.data.datasets[3].data = chartData.map(p => ({x: p.x, y: p.y4}));
            
            realTimeChart.update();
        }

        function updateAnalytics(data) {
            document.getElementById('total-readings').textContent = data.totalReadings;
            document.getElementById('alerts-count').textContent = data.alertsCount;
            document.getElementById('time-range').textContent = 
                `${new Date(data.timeRange.from).toLocaleDateString()} - ${new Date(data.timeRange.to).toLocaleDateString()}`;

            // Actualizar gráfico de promedios
            averageChart.data.datasets[0].data = [
                data.averageValues.sensor1,
                data.averageValues.sensor2,
                data.averageValues.sensor3,
                data.averageValues.sensor4
            ];
            averageChart.update();

            // Mostrar estado de sensores
            updateSensorStatus(data);
        }

        function updateSensorStatus(data) {
            const alertsContainer = document.getElementById('sensor-alerts');
            alertsContainer.innerHTML = '';

            ['sensor1', 'sensor2', 'sensor3', 'sensor4'].forEach((sensor, index) => {
                const value = data.averageValues[sensor];
                const isAlert = value < 10 || value > 200;
                
                const div = document.createElement('div');
                div.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 8px;
                    margin: 4px 0;
                    border-radius: 4px;
                    background: ${isAlert ? '#ffebee' : '#e8f5e8'};
                    border-left: 4px solid ${isAlert ? '#e74c3c' : '#2ecc71'};
                `;
                
                div.innerHTML = `
                    <span>Sensor ${index + 1}:</span>
                    <span style="font-weight: bold; color: ${isAlert ? '#e74c3c' : '#2ecc71'}">
                        ${isAlert ? '⚠️ Alerta' : '✅ Normal'}
                    </span>
                `;
                
                alertsContainer.appendChild(div);
            });
        }

        function updateRealtimeDisplay(data) {
            if (data && data.data) {
                updateCurrentValues(data.data);
                
                // Si estamos viendo período corto, actualizar gráfico
                if (currentPeriod <= 6) {
                    loadChartData(currentPeriod);
                }
            }
        }

        async function loadChartData(hours) {
            try {
                const response = await fetch(`/api/sensors/chart-data?hours=${hours}`);
                const data = await response.json();
                
                if (data.success) {
                    updateRealtimeChart(data.data);
                }
            } catch (error) {
                console.error('Error al cargar datos del gráfico:', error);
            }
        }
    </script>
</body>
</html>